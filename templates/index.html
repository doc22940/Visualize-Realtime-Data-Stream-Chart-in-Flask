<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Creating Real-Time Charts with Flask</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.css" rel="stylesheet">

    <script src="//code.jquery.com/jquery-3.3.1.min.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
    <script>

    function new_card(content) {
        var listview = document.getElementById("listview");

        var card = document.createElement("DIV");
        card.className = "card";
        var card_body = document.createElement("DIV");
        card_body.className = "card-body";

        card_body.appendChild(content);
        card.appendChild(card_body);

        // appending button to div
        listview.appendChild(card);
    }

    function create_new_config(data) {
        switch(data.type) {
    case 'line':
      return  simple_config(data);
      break;
    case 'bar':
      return  simple_config(data);
      break;
    case 'pie':
      return  no_axis_config(data);
      break;
    case 'radar':
      return  no_axis_config(data);
      break;
    case 'polarArea':
      return  no_axis_config(data);
      break;
    case 'doughnut':
      return  no_axis_config(data);
      break;
    case 'horizontalBar':
      return simple_config(data);
    break;
    case 'bubble':
      return  simple_config(data);
      break;
default:

}
    }

    function no_axis_config(data){
      return  config = {
            type: data.type,
            id: data.id,

            width: data.width,
            height: data.height,

            data: {
                labels: [],
                datasets: [{
                    label: data.legend,
                    backgroundColor: data.backgroundColor,
                    borderColor: data.borderColor,
                    data: [],
                    fill: false,
                }],
            },
            options: {
                responsive: true,
                title: {
                    display: true,
                    text: data.name
                },
                tooltips: {
                    mode: 'index',
                    intersect: false,
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
            }
        };


    }

    function simple_config(data){
      return  config = {
            type: data.type,
            id: data.id,

            width: data.width,
            height: data.height,

            data: {
                labels: [],
                datasets: [{
                    label: data.legend,
                    backgroundColor: data.backgroundColor,
                    borderColor: data.borderColor,
                    data: [],
                    fill: false,
                }],
            },
            options: {
                responsive: true,
                title: {
                    display: true,
                    text: data.name
                },
                tooltips: {
                    mode: 'index',
                    intersect: false,
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                },
                scales: {
                    xAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: 'Time'
                        }
                    }],
                    yAxes: [{
                        display: true,
                        scaleLabel: {
                            display: true,
                            labelString: data.label
                        }
                    }]
                }

            }
        };

    }

    var paus = false;


    $(document).ready(function(){
        //connect to the socket server.
        var socket = io.connect('http://' + document.domain + ':' + location.port + '/test');
        var numbers_received = [];
        var ChartList = [];

        //receive details from server
        socket.on('server', function(data) {
              //  console.log(data)
                var config;
                var ctx;
                if(document.getElementById(data.id)){

                ChartList.forEach(function(chart){
              //      console.log(chart);
                    if(chart.config.id == data.id){
                      config = chart.config;
                      ctx = chart;
                    }
                  });
                  if( config == null || ctx == null || paus){
                    return;
                  }


                  if (config.data.labels.length === data.active_points) {
                      config.data.labels.shift();
                      config.data.datasets[0].data.shift();
                  }
                  config.data.labels.push(data.time);
                  config.data.datasets[0].data.push(data.value);
                  ctx.update();

                } else {
                  // Create graph

                  var canvas = document.createElement('CANVAS');
                  canvas.id = data.id;

                  var config = create_new_config(data);

                  var lineChart = new Chart(canvas, config);
                //  lineChart.id = data.id+"chart";

                ChartList.push(lineChart);
              //  console.log(lineChart);
              //  console.log(canvas);
                  new_card(canvas);

                }
            });
    });


    function clear_func(){
    // Remove all charts and data
    console.log("clear");
    ChartList = [];

    var listview = document.getElementById('listview');
    console.log(listview);

    var children = listview.children;
    console.log(children);

    for (let child of children) {
      if(child.id != "buttons"){
        child.remove()
      }
    }

    children.forEach(function(child){
      child.remove();
    });
  }

    function paus_func(){
      // Toggle paus variable
      if (paus){
        paus = false;
      } else {
        paus = true;
      }
    }

    </script>

    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
</head>
<body>
  <body>
  <div class="container">
      <div class="row">
          <div class="col-12" id="listview">
              <div class="card" id="buttons">
                  <div class="card-body">
                    <input type="submit" name="Reset_button" value="Clear All" onclick="clear_func();">
                    <input type="submit" name="Paus_button" value="Paus Toggle" onclick="paus_func();">
                </div>
              </div>
          </div>
      </div>
  </div>
  <!--suppress JSUnresolvedLibraryURL -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
  <!--suppress JSUnresolvedLibraryURL -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <!--suppress JSUnresolvedLibraryURL -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
  <script>

      </script>
  </body>
  </html>
